@{
    ViewData["Title"] = "Roles";
}
<div class="app-page-title">
    <div class="page-title-wrapper">
        <div class="page-title-heading">
            <div class="page-title-icon">
                <i class="pe-7s-users icon-gradient bg-tempting-azure">
                </i>
            </div>
            <div>
                Roles
                <div class="page-title-subheading">
                    <a title="Home" href="@Url.Content("~/Home")">Home</a> / Roles
                </div>
            </div>
        </div>
    </div>
</div>
<div class="row">
	<div class="col-lg-12">
		<div class="main-card mb-12 card">
			<div class="card-header">
				<button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#modal1" id="btnAdd"><i class="fa fa-plus"></i> Add</button>
			</div>
			<div class="card-body">
				<table class="display table table-bordered table-hover" id="table1" style="width:100%">
					<thead>
						<tr>
							<th>Action</th>
							<th>Name</th>
							<th>Description</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
	</div>
</div>
@section Modal {
	<div class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modal1" aria-hidden="true" id="modal1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="modal1Title">Add Role</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<form id="form1" method="POST" action="@Url.Content("~/Roles/CreateOrUpdate")">
					<div class="modal-body">
						<input type="hidden" name="id" id="id" value="" style="display: none" />
						<div class="position-relative row form-group">
							<label for="name" class="col-sm-2 col-form-label">Name</label>
							<div class="col-sm-10"><input name="name" id="name" placeholder="Name" type="text" class="form-control" required="" maxlength="50" ></div>
						</div>
						<div class="position-relative row form-group">
							<label for="description" class="col-sm-2 col-form-label">Description</label>
							<div class="col-sm-10"><textarea name="description" id="description" class="form-control" placeholder="Description" style="resize:none" required="" maxlength="200"></textarea></div>
						</div>
						<table class="table table-bordered table-hover" id="table2">
							<thead>
								<tr>
									<th><input type="checkbox" id="checkboxAll" /></th>
									<th>Module</th>
									<th>Function</th>
								</tr>
							</thead>
							<tbody></tbody>
						</table>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal" id="btnClose">Close</button>
						<button type="submit" class="btn btn-primary" id="btnSave">Save</button>
					</div>
				</form>
			</div>
		</div>
	</div>
}
@section Scripts {
	<script type="text/javascript">
		$(function () {
			var table = $('#table1').DataTable({
				ajax: {
					url: "Roles/GetAllData",
					type: "POST",
				},
				processing: true,
				serverSide: true,
				filter: false,
				order: [[1, 'asc']],
				columns: [
					{ defaultContent: '<i class="fa fa-eye btnView" style="cursor:pointer" data-toggle="modal" data-target="#modal1"></i> &nbsp; <i class="fa fa-edit btnEdit" style="cursor:pointer" data-toggle="modal" data-target="#modal1"></i> &nbsp; <i class="fa fa-trash btnDelete" style="cursor:pointer"></i>' },
					{ data: "name", name: "name" },
					{ data: "description", name: "description" }
				]
			});

			$('#table1 tbody').on('click', '.btnView', function () {
				var row = $(this).closest('tr');
				var id = table.row(row).data()["id"];

				$('#modal1Title').text('View Role');
				$('#btnSave').hide();
				$("#form1 :input").prop("disabled", true);
				$("#btnClose").prop("disabled", false);

				$.ajax({
					type: 'GET',
					url: '@Url.Content("~/Roles/GetById/")' + id,
					success: function (data) {
						$('#name').val(data.name);
						$('#description').val(data.description);
					}
				});
				addModuleToTable(id, true);
			});

			$('#table1 tbody').on('click', '.btnEdit', function () {
				var row = $(this).closest('tr');
				var id = table.row(row).data()["id"];

				$('#modal1Title').text('Edit Role');
				$('#btnSave').show();
				$("#form1 :input").prop("disabled", false);

				$.ajax({
					type: 'GET',
					url: '@Url.Content("~/Roles/GetById/")' + id,
					success: function (data) {
						$('#id').val(data.id);
						$('#name').val(data.name);
						$('#description').val(data.description);
					}
				});
				addModuleToTable(id);
			});

			$('#table1 tbody').on('click', '.btnDelete', function () {
				var row = $(this).closest('tr');
				var id = table.row(row).data()["id"];

				Swal.fire({
					title: "Are you sure want to delete?",
					showCancelButton: true,
					confirmButtonText: "Delete",
				}).then((result) => {
					if (result.isConfirmed) {

						$.ajax({
							type: 'DELETE',
							url: '@Url.Content("~/Roles/Delete/")' + id,
							success: function (data) {
								ShowMessage("success", data);
								table.ajax.reload();
							}
						});
					}
				});
			});

			$('#btnAdd').click(function () {
				$('#modal1Title').text('Add Role');
				$('#btnSave').show();
				$("#form1 :input").prop("disabled", false);
				$("#form1 :input").val('');

				addModuleToTable(null);
			});

			$('#form1').submit(function (e) {
				e.preventDefault();

				let form = $(this);
				let actionUrl = form.attr('action');
				let formFinal = form.serialize();

				var array = [];
				var checkboxes = $('#table2 tbody input[type=checkbox][name=ModuleFunction]:checked');
				for (var i = 0; i < checkboxes.length; i++) {
					array.push(checkboxes[i].value);
				}
				formFinal += "&Functions=" + array;

				$.ajax({
					type: 'POST',
					url: actionUrl,
					data: formFinal,
					success: function (data) {
						ShowMessage("success", data);
						$("#btnClose").click();
						table.ajax.reload();
					},
					error: function (data) {
						ShowMessage("error", data.responseText);
					}
				});
			});

			$('#table2 #checkboxAll').change(function () {
				if (this.checked) {
					$('#table2 tbody input[type=checkbox]').prop('checked', true);
				} else {
					$('#table2 tbody input[type=checkbox]').prop('checked', false);
				}
			});
			$(document).on('click', '#table2 .checkboxModule', function () {
				var moduleName = $(this).attr("moduleName");
				let selector1 = '#table2 tbody input[type=checkbox].' + moduleName;
				if (this.checked) {
					$(selector1).prop('checked', true);
				} else {
					$(selector1).prop('checked', false);
				}
			});



		});

		function addModuleToTable(roleId, isView = false){
			$('#checkboxAll').prop("checked", false);
			$("#table2 tbody").html("");
			$.ajax({
				type: 'GET',
				url: '@Url.Content("~/Roles/GetAllModule?roleId=")' + roleId,
				success: function (data) {
					let checkedAll = true;
					$.each(data, function (index, data1) {
						let functions = '';
						let checkedModule = "checked";
						$.each(data1.functions, function (index, data2) {
							let checkedFunction = "";
							if (data2.isChecked) {
								checkedFunction = "checked";
							}
							if (!data2.isChecked) {
								checkedModule = "";
								checkedAll = false;
							}
							functions += '<div class="form-check form-check-inline"><input class="form-check-input ' + data1.module + '" name="ModuleFunction" type="checkbox" id="' + data2.id + '" value="' + data2.id + '" ' + checkedFunction + '><label class="form-check-label" for="' + data2.id + '">' + data2.function + '</label></div>';
						});
						$('#table2 tbody:last-child').append('<tr><td><input type="checkbox" class="checkboxModule" moduleName="' + data1.module + '" ' + checkedModule + ' /></td><td>' + data1.module + '</td><td>' + functions + '</td></tr>');
					});
					if(isView){
						$("#form1 :input").prop("disabled", true);
						$("#btnClose").prop("disabled", false);
					}
					if(checkedAll){
						$('#checkboxAll').prop("checked", true);
					}
				}
			});
		}
	</script>
}